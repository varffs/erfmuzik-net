function getRandomInt(e,o){return Math.floor(Math.random()*(o-e+1))+e}function trim(e){e=e.replace(/^\s+/,"");for(var o=e.length-1;o>=0;o--)if(/\S/.test(e.charAt(o))){e=e.substring(0,o+1);break}return e}function playAudio(){if(window.AudioContext=window.AudioContext||window.webkitAudioContext,!("AudioContext"in window))return void alert("Your browser does not yet support the Web Audio API");audioContext=new AudioContext,analyser=audioContext.createAnalyser(),analyser.smoothingTimeConstant=.8,analyser.fftSize=1024,analyser.connect(audioContext.destination),binCount=analyser.frequencyBinCount,levelBins=Math.floor(binCount/levelsCount),freqByteData=new Uint8Array(binCount),timeByteData=new Uint8Array(binCount);for(var e=256,o=0;e>o;o++)levelHistory.push(0);source=audioContext.createBufferSource(),source.connect(analyser);var a=new XMLHttpRequest;a.open("GET",sampleAudioURL,!0),a.responseType="arraybuffer",a.onload=function(){audioContext.decodeAudioData(a.response,function(e){source.buffer=e,source.loop=!0,source.start(0),isPlayingAudio=!0},function(e){console.log(e)})},a.send()}function analysis(){analyser.getByteFrequencyData(freqByteData),analyser.getByteTimeDomainData(timeByteData);for(var e=0;binCount>e;e++)waveData[e]=(timeByteData[e]-128)/128*volSens;for(var e=0;levelsCount>e;e++){for(var o=0,a=0;levelBins>a;a++)o+=freqByteData[e*levelBins+a];levelsData[e]=o/levelBins/256*volSens}for(var o=0,a=0;levelsCount>a;a++)o+=levelsData[a];level=o/levelsCount,levelHistory.push(level),levelHistory.shift(1)}function setup3d(){scene=new THREE.Scene,camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),renderer=new THREE.WebGLRenderer({antialias:!0}),renderer.shadowMapEnabled=!0,renderer.setSize(window.innerWidth,window.innerHeight),renderer.setClearColor("#CCCCCC"),controls=new THREE.OrbitControls(camera,renderer.domElement),window.addEventListener("resize",function(){var e=window.innerWidth,o=window.innerHeight;renderer.setSize(e,o),camera.aspect=e/o,camera.updateProjectionMatrix()}),document.body.appendChild(renderer.domElement);var e=new THREE.HemisphereLight("#FFFFFF","#000000",.8);scene.add(e);var o=new THREE.SpotLight(16777215);o.position.set(1e3,100,100),o.castShadow=!0,o.shadowMapWidth=1024,o.shadowMapHeight=1024,o.shadowCameraNear=500,o.shadowCameraFar=4e3,o.shadowCameraFov=30,scene.add(o);var a=new THREE.SpotLight(16777215);a.position.set(-1e3,100,-100),scene.add(a);var r=new XMLHttpRequest;r.onreadystatechange=function(){if(4==r.readyState&&(200==r.status||0==r.status)){var e=r.response;parseStlBinary(e),mesh.rotation.x=5,mesh.rotation.z=.25}},r.onerror=function(e){console.log(e)},r.open("GET","dist/assets/3d/girder-cube.stl",!0),r.responseType="arraybuffer",r.send(null),camera.position.z=8}function render(){if(requestAnimationFrame(render),renderer.render(scene,camera),isPlayingAudio){analysis();var e=waveData[getRandomInt(50,60)]/6,o=waveData[getRandomInt(410,470)]/6,a=waveData[getRandomInt(150,250)]/15;mesh&&(mesh.rotation.x+=e>.005?e:.005,mesh.rotation.y+=o>.005?o:.005,camera.position.z<3.6&&(camera.position.z=camera.position.z*(a+1.75)),camera.position.z=camera.position.z*(a+1))}else mesh&&(mesh.rotation.x+=.005,mesh.rotation.y+=.005)}var limitFrames=5e3,frames=0,source,buffer,audioBuffer,dropArea,audioContext,processor,analyser,sampleAudioURL="dist/assets/mp3/ERFMUZIK-VOL1-SOUNDSCAPE.mp3",isPlayingAudio=!1,waveData=[],levelsData=[],level=0,bpmTime=0,ratedBPMTime=550,levelHistory=[],bpmStart,freqByteData,timeByteData,levelsCount=4,volSens=1,scene,camera,renderer,mesh,mesh2,parseStlBinary=function(e){for(var o=new THREE.Geometry,a=new DataView(e,80),r=!0,t=a.getUint32(0,r),n=4,s=0;t>s;s++){var i=new THREE.Vector3(a.getFloat32(n,r),a.getFloat32(n+4,r),a.getFloat32(n+8,r));n+=12;for(var l=0;3>l;l++)o.vertices.push(new THREE.Vector3(a.getFloat32(n,r),a.getFloat32(n+4,r),a.getFloat32(n+8,r))),n+=12;n+=2,o.faces.push(new THREE.Face3(3*s,3*s+1,3*s+2,i))}o.computeFaceNormals(),THREE.GeometryUtils.center(o),mesh=new THREE.Mesh(o,new THREE.MeshLambertMaterial({overdraw:!0,color:"#b0b0b0",shading:THREE.FlatShading})),mesh.castShadow=!0,mesh.receiveShadow=!0,mesh.position.x=0,mesh.position.y=0,mesh.position.z=0,scene.add(mesh),e=null},parseStl=function(e){var o,a,r,t,n,s="",i=e.split("\n"),l=new THREE.Geometry,d=0;e=null;for(var c=i.length,u=0;c>u&&!n;u++)switch(r=trim(i[u]),a=r.split(" "),s){case"":if("solid"!==a[0])return console.error(r),void console.error('Invalid state "'+a[0]+'", should be "solid"');o=a[1],s="solid";break;case"solid":if("facet"!==a[0]||"normal"!==a[1])return console.error(r),void console.error('Invalid state "'+a[0]+'", should be "facet normal"');t=[parseFloat(a[2]),parseFloat(a[3]),parseFloat(a[4])],s="facet normal";break;case"facet normal":if("outer"!==a[0]||"loop"!==a[1])return console.error(r),void console.error('Invalid state "'+a[0]+'", should be "outer loop"');s="vertex";break;case"vertex":if("vertex"===a[0])l.vertices.push(new THREE.Vector3(parseFloat(a[1]),parseFloat(a[2]),parseFloat(a[3])));else{if("endloop"!==a[0])return console.error(r),void console.error('Invalid state "'+a[0]+'", should be "vertex" or "endloop"');l.faces.push(new THREE.Face3(3*d,3*d+1,3*d+2,new THREE.Vector3(t[0],t[1],t[2]))),d++,s="endloop"}break;case"endloop":if("endfacet"!==a[0])return console.error(r),void console.error('Invalid state "'+a[0]+'", should be "endfacet"');s="endfacet";break;case"endfacet":if("endsolid"===a[0])mesh=new THREE.Mesh(l,new THREE.MeshLambertMaterial({overdraw:!0,color:11141120,shading:THREE.FlatShading})),scene.add(mesh),n=!0;else{if("facet"!==a[0]||"normal"!==a[1])return console.error(r),void console.error('Invalid state "'+a[0]+'", should be "endsolid" or "facet normal"');t=[parseFloat(a[2]),parseFloat(a[3]),parseFloat(a[4])],d%1e3===0&&console.log(t),s="facet normal"}break;default:console.error('Invalid state "'+s+'"')}};playAudio(),setup3d(),render();