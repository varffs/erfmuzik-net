function getRandomInt(e,r){return Math.floor(Math.random()*(r-e+1))+e}function trim(e){e=e.replace(/^\s+/,"");for(var r=e.length-1;r>=0;r--)if(/\S/.test(e.charAt(r))){e=e.substring(0,r+1);break}return e}function playAudio(){if(window.AudioContext=window.AudioContext||window.webkitAudioContext,!("AudioContext"in window))return void alert("Your browser does not yet support the Web Audio API");audioContext=new AudioContext,processor=audioContext.createScriptProcessor(2048,1,1),analyser=audioContext.createAnalyser(),analyser.smoothingTimeConstant=.8,analyser.fftSize=1024,analyser.connect(audioContext.destination),binCount=analyser.frequencyBinCount,levelBins=Math.floor(binCount/levelsCount),freqByteData=new Uint8Array(binCount),timeByteData=new Uint8Array(binCount);for(var e=256,r=0;e>r;r++)levelHistory.push(0);source=audioContext.createBufferSource(),source.connect(analyser);var o=new XMLHttpRequest;o.open("GET",sampleAudioURL,!0),o.responseType="arraybuffer",o.onload=function(){audioBuffer=audioContext.createBuffer(o.response,!1),source.buffer=audioBuffer,source.loop=!0,source.noteOn(0),isPlayingAudio=!0},o.send()}function analysis(){analyser.getByteFrequencyData(freqByteData),analyser.getByteTimeDomainData(timeByteData);for(var e=0;binCount>e;e++)waveData[e]=(timeByteData[e]-128)/128*volSens;for(var e=0;levelsCount>e;e++){for(var r=0,o=0;levelBins>o;o++)r+=freqByteData[e*levelBins+o];levelsData[e]=r/levelBins/256*volSens}for(var r=0,o=0;levelsCount>o;o++)r+=levelsData[o];level=r/levelsCount,levelHistory.push(level),levelHistory.shift(1)}function setup3d(){scene=new THREE.Scene,camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),renderer=new THREE.WebGLRenderer({antialias:!0}),renderer.shadowMapEnabled=!0,renderer.setSize(window.innerWidth,window.innerHeight),renderer.setClearColor("#000"),controls=new THREE.OrbitControls(camera,renderer.domElement),window.addEventListener("resize",function(){var e=window.innerWidth,r=window.innerHeight;renderer.setSize(e,r),camera.aspect=e/r,camera.updateProjectionMatrix()}),document.body.appendChild(renderer.domElement);var e=new THREE.HemisphereLight("#FFFFFF","#000000",.8);scene.add(e);var r=new THREE.SpotLight(16777215);r.position.set(1e3,100,100),r.castShadow=!0,r.shadowMapWidth=1024,r.shadowMapHeight=1024,r.shadowCameraNear=500,r.shadowCameraFar=4e3,r.shadowCameraFov=30,scene.add(r);var o=new THREE.SpotLight(16777215);o.position.set(-1e3,100,-100),scene.add(o);var a=new XMLHttpRequest;a.onreadystatechange=function(){if(4==a.readyState&&(200==a.status||0==a.status)){var e=a.response;parseStlBinary(e),mesh.rotation.x=5,mesh.rotation.z=.25}},a.onerror=function(e){console.log(e)},a.open("GET","dist/assets/3d/girder-cube.stl",!0),a.responseType="arraybuffer",a.send(null),camera.position.z=7}function render(){if(limitFrames>frames){if(requestAnimationFrame(render),renderer.render(scene,camera),isPlayingAudio){analysis();var e=waveData[getRandomInt(50,60)]/5,r=waveData[getRandomInt(430,460)]/5;mesh&&(mesh.rotation.x+=e,mesh.rotation.y+=r)}else mesh&&(mesh.rotation.x+=.01,mesh.rotation.y+=.01);frames++}}var limitFrames=5e3,frames=0,source,buffer,audioBuffer,dropArea,audioContext,processor,analyser,sampleAudioURL="dist/assets/mp3/Lo2tha.mp3",isPlayingAudio=!1,waveData=[],levelsData=[],level=0,bpmTime=0,ratedBPMTime=550,levelHistory=[],bpmStart,freqByteData,timeByteData,levelsCount=4,volSens=1,scene,camera,renderer,mesh,mesh2,parseStlBinary=function(e){for(var r=new THREE.Geometry,o=new DataView(e,80),a=!0,t=o.getUint32(0,a),n=4,s=0;t>s;s++){var i=new THREE.Vector3(o.getFloat32(n,a),o.getFloat32(n+4,a),o.getFloat32(n+8,a));n+=12;for(var l=0;3>l;l++)r.vertices.push(new THREE.Vector3(o.getFloat32(n,a),o.getFloat32(n+4,a),o.getFloat32(n+8,a))),n+=12;n+=2,r.faces.push(new THREE.Face3(3*s,3*s+1,3*s+2,i))}r.computeFaceNormals(),THREE.GeometryUtils.center(r),mesh=new THREE.Mesh(r,new THREE.MeshLambertMaterial({overdraw:!0,color:"#b0b0b0",shading:THREE.FlatShading})),mesh.castShadow=!0,mesh.receiveShadow=!0,mesh.position.x=0,mesh.position.y=0,mesh.position.z=0,scene.add(mesh),e=null},parseStl=function(e){var r,o,a,t,n,s="",i=e.split("\n"),l=new THREE.Geometry,d=0;e=null;for(var c=i.length,u=0;c>u&&!n;u++)switch(a=trim(i[u]),o=a.split(" "),s){case"":if("solid"!==o[0])return console.error(a),void console.error('Invalid state "'+o[0]+'", should be "solid"');r=o[1],s="solid";break;case"solid":if("facet"!==o[0]||"normal"!==o[1])return console.error(a),void console.error('Invalid state "'+o[0]+'", should be "facet normal"');t=[parseFloat(o[2]),parseFloat(o[3]),parseFloat(o[4])],s="facet normal";break;case"facet normal":if("outer"!==o[0]||"loop"!==o[1])return console.error(a),void console.error('Invalid state "'+o[0]+'", should be "outer loop"');s="vertex";break;case"vertex":if("vertex"===o[0])l.vertices.push(new THREE.Vector3(parseFloat(o[1]),parseFloat(o[2]),parseFloat(o[3])));else{if("endloop"!==o[0])return console.error(a),void console.error('Invalid state "'+o[0]+'", should be "vertex" or "endloop"');l.faces.push(new THREE.Face3(3*d,3*d+1,3*d+2,new THREE.Vector3(t[0],t[1],t[2]))),d++,s="endloop"}break;case"endloop":if("endfacet"!==o[0])return console.error(a),void console.error('Invalid state "'+o[0]+'", should be "endfacet"');s="endfacet";break;case"endfacet":if("endsolid"===o[0])mesh=new THREE.Mesh(l,new THREE.MeshLambertMaterial({overdraw:!0,color:11141120,shading:THREE.FlatShading})),scene.add(mesh),n=!0;else{if("facet"!==o[0]||"normal"!==o[1])return console.error(a),void console.error('Invalid state "'+o[0]+'", should be "endsolid" or "facet normal"');t=[parseFloat(o[2]),parseFloat(o[3]),parseFloat(o[4])],d%1e3===0&&console.log(t),s="facet normal"}break;default:console.error('Invalid state "'+s+'"')}};setup3d(),render();